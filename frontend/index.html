<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FaceNew</title>
  <!-- Imports duplicados eliminados: heroicons.js y sdk.js -->
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <nav>
      <a href="/paginas" id="nav-paginas">Páginas</a>
      <a href="/buscar-autor" id="nav-autores">Autores</a>
      <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
        <span id="user-icon-container" style="cursor:pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="28" height="28">
            <circle cx="12" cy="8" r="4" stroke-width="2"/>
            <path stroke-width="2" d="M4 20c0-3.314 3.134-6 7-6s7 2.686 7 6"/>
          </svg>
        </span>
      </div>
    <!-- Popup modal para registro y login -->
    <div id="user-popup-bg" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:999;"></div>
    <div id="user-popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; color:#222; box-shadow:0 4px 24px #0004; border-radius:12px; min-width:280px; z-index:1000; padding:32px 24px; transition:opacity 0.2s; opacity:0;">
      <div id="dropdown-register" style="margin-bottom:24px;">
        <form id="registerForm">
          <h3 style="margin-top:0">Registro</h3>
          <label>Email:
            <input type="email" id="regEmail" required />
          </label>
          <label>Contraseña:
            <input type="password" id="regPass" required />
          </label>
          <button type="submit">Registrar</button>
        </form>
      </div>
      <div id="dropdown-login">
        <form id="loginForm">
          <h3 style="margin-top:0">Login</h3>
          <label>Email:
            <input type="email" id="logEmail" required />
          </label>
          <label>Contraseña:
            <input type="password" id="logPass" required />
          </label>
          <button type="submit">Iniciar Sesión</button>
        </form>
      </div>
    </div>
    <script type="module">
    import { register, login } from './sdk.js';
    // Mostrar popup al hacer clic en el icono de usuario y manejar registro/login con mensajes en el output
    document.addEventListener('DOMContentLoaded', function() {
      const icon = document.getElementById('user-icon-container');
      const popup = document.getElementById('user-popup');
      const popupBg = document.getElementById('user-popup-bg');
      if (icon && popup && popupBg) {
        icon.addEventListener('click', function(e) {
          e.stopPropagation();
          popup.style.display = 'block';
          popupBg.style.display = 'block';
          setTimeout(() => { popup.style.opacity = '1'; }, 10);
        });
        // Ocultar popup al hacer clic fuera
        popupBg.addEventListener('click', function() {
          popup.style.opacity = '0';
          setTimeout(() => {
            popup.style.display = 'none';
            popupBg.style.display = 'none';
          }, 200);
        });
        // Ocultar popup al presionar Escape
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && popup.style.display === 'block') {
            popup.style.opacity = '0';
            setTimeout(() => {
              popup.style.display = 'none';
              popupBg.style.display = 'none';
            }, 200);
          }
        });
        // Registro
        const regForm = document.getElementById('registerForm');
        if (regForm) {
          regForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPass').value;
            if (email && password) {
              const result = await register(email, password);
              if (result.success) {
                window.showOutput(result.data?.message || 'Registro exitoso', 'success');
                regForm.reset();
              } else {
                window.showOutput(result.data?.message || result.data?.error || 'Error en el registro', 'error');
              }
            } else {
              window.showOutput('Error en el registro', 'error');
            }
          });
        }
        // Login
        const logForm = document.getElementById('loginForm');
        if (logForm) {
          logForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('logEmail').value;
            const password = document.getElementById('logPass').value;
            if (email && password) {
              const result = await login(email, password);
              if (result.success) {
                window.showOutput(result.data?.message || 'Login exitoso', 'success');
                logForm.reset();
              } else {
                window.showOutput(result.data?.message || result.data?.error || 'Error en el login', 'error');
              }
            } else {
              window.showOutput('Error en el login', 'error');
            }
          });
        }
      }
    });
    </script>
    </nav>
    <div id="section-paginas" style="display: none; margin-bottom: 32px">
      <!-- Páginas -->
      <form id="paginaForm">
        <h3>Crear nueva página</h3>
        <label>Título:
          <input type="text" id="paginaTitulo" required />
        </label>
        <label>Contenido:
          <textarea id="paginaContenido" rows="4" required></textarea>
        </label>
        <div style="margin:16px 0">
          <h4>Elementos arrastrables</h4>
          <div id="drag-items" style="display:flex; gap:10px;">
            <div draggable="true" class="drag-item" data-type="imagen" style="padding:8px; background:#eee; border-radius:5px; cursor:grab;">Imagen</div>
            <div draggable="true" class="drag-item" data-type="video" style="padding:8px; background:#eee; border-radius:5px; cursor:grab;">Video</div>
            <div draggable="true" class="drag-item" data-type="texto" style="padding:8px; background:#eee; border-radius:5px; cursor:grab;">Texto extra</div>
          </div>
          <div id="drop-area" style="margin-top:12px; min-height:40px; background:#f3f3f3; border:2px dashed #bbb; border-radius:6px; padding:10px;">Arrastra aquí para añadir a tu página</div>
        </div>
        <button type="submit">Crear Página</button>
      </form>
    </div>
    <!-- Sección mis páginas movida fuera de section-paginas -->
    <!-- Eliminada sección Mis páginas -->
    <!-- Vista de autores -->
    <div id="section-buscar-autor" style="display:none; margin-bottom:32px">
  <!-- Sección de búsqueda de autor eliminada -->
  <h3>Páginas públicas de autores</h3>
  <ul id="listaPublicasAutores"></ul>
    </div>

    <!-- Output global, siempre visible en la parte inferior -->
    <div id="output-menu-container" style="position:fixed; left:0; bottom:0; width:100vw; z-index:1200; pointer-events:none;">
      <div id="output-menu" style="width:100vw; max-width:480px; margin:0 auto; background:#fff; color:#222; box-shadow:0 -4px 24px #0004; border-radius:16px 16px 0 0; padding:24px 16px 32px 16px; position:relative; bottom:0; opacity:1; transition:bottom 0.3s, opacity 0.3s; pointer-events:auto;">
        <button id="output-min-btn" style="position:absolute; right:12px; top:16px; background:transparent; color:#222; border:none; border-radius:50%; padding:0; width:16px; height:16px; font-size:1em; cursor:pointer; pointer-events:auto; box-shadow:none; display:flex; align-items:center; justify-content:center;">
          <span id="output-arrow-hide" style="display:inline; font-size:16px; color:#222; width:16px; height:16px; line-height:16px; text-align:center;">&#x25BC;</span>
        </button>
        <button id="output-restore-btn" style="position:fixed; left:50%; transform:translateX(-50%); bottom:0; z-index:1300; background:#eee; color:#222; border:none; border-radius:16px 16px 0 0; padding:6px 18px; font-size:1.7em; cursor:pointer; box-shadow:0 -2px 8px #0002; display:none;">
          <span id="output-arrow-show" style="font-size:1em; color:#222;">&#x25B2;</span>
        </button>
        <div id="output-area" style="min-height:32px; font-size:1em; color:#222; margin-top:8px;"></div>
      </div>
    </div>
    <div id="section-ver-pagina" style="display:none; margin-bottom:32px">
      <div id="paginaPublica"></div>
    </div>

    <!-- Modal edición de elemento -->
    <div id="modal-editar" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); justify-content:center; align-items:center; z-index:1000;">
      <div style="background:#fff; padding:24px; border-radius:8px; min-width:280px; box-shadow:0 2px 8px #0002;">
        <h3>Editar elemento</h3>
        <form id="formEditarElemento">
          <label>Tipo:
            <input type="text" id="editTipo" required />
          </label>
          <label>Contenido:
            <input type="text" id="editContenido" required />
          </label>
          <div style="margin-top:12px; display:flex; gap:8px;">
            <button type="submit">Guardar</button>
            <button type="button" id="cancelarEditar">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <script type="module" src="sdk.js"></script>
    <script type="module">
// Menú de consola siempre visible con botón para minimizar/restaurar
const outputMenu = document.getElementById('output-menu');
const outputMinBtn = document.getElementById('output-min-btn');
const arrowHide = document.getElementById('output-arrow-hide');
const outputRestoreBtn = document.getElementById('output-restore-btn');
let outputMinimized = false;
function toggleOutputMinimize() {
  outputMinimized = !outputMinimized;
  if (outputMinimized) {
    outputMenu.style.bottom = '-120px';
    outputMenu.style.opacity = '0.5';
    arrowHide.style.display = 'none';
    outputRestoreBtn.style.display = 'block';
  } else {
    outputMenu.style.bottom = '0';
    outputMenu.style.opacity = '1';
    arrowHide.style.display = 'inline';
    outputRestoreBtn.style.display = 'none';
  }
}
outputMinBtn.addEventListener('click', toggleOutputMinimize);
outputRestoreBtn.addEventListener('click', toggleOutputMinimize);

// El output permanece siempre fijo en la parte inferior, nunca se mueve al popup

// ...existing code...
import { register, login, createPage, getMyPages, getPublicPages, getPageById, importHeroicon } from './sdk.js';
// Sobrescribir showOutput para mantener el output visible en el menú
window.showOutput = function(message, type = "info") {
  const output = document.getElementById("output-area");
  if (output) {
    if (Array.isArray(message)) {
      output.innerHTML = message.map(m => `<div>${m}</div>`).join("");
    } else {
      output.textContent = message;
    }
    output.style.color = type === "success" ? "green" : type === "error" ? "red" : "orange";
    output.style.display = "block";
  }
}

// Registro
// Drag and drop para añadir elementos a la página
const dropArea = document.getElementById("drop-area");
const dragItems = document.querySelectorAll(".drag-item");
let elementosArrastrados = [];
let editandoIdx = null;
// ...existing code...

dragItems.forEach(item => {
  item.addEventListener("dragstart", (e) => {
    e.dataTransfer.setData("text/plain", item.dataset.type);
  });
});

dropArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropArea.style.background = "#e0f7fa";
});
dropArea.addEventListener("dragleave", () => {
  dropArea.style.background = "#f3f3f3";
});
dropArea.addEventListener("drop", (e) => {
  e.preventDefault();
  dropArea.style.background = "#f3f3f3";
  const tipo = e.dataTransfer.getData("text/plain");
  const idx = elementosArrastrados.length;
  elementosArrastrados.push({ tipo, contenido: "" });
  renderElementosDrop();
});

function renderElementosDrop() {
  dropArea.innerHTML = "";
  elementosArrastrados.forEach((el, idx) => {
    const span = document.createElement("span");
    span.textContent = `${el.tipo}${el.contenido ? ': ' + el.contenido : ''}`;
    span.style.marginRight = "8px";
    span.style.padding = "4px 8px";
    span.style.background = "#d1e7dd";
    span.style.borderRadius = "4px";
    span.style.cursor = "pointer";
    span.title = "Haz clic para editar, doble clic para eliminar";
    span.dataset.idx = idx;
    // Eliminar elemento
    span.addEventListener("dblclick", function() {
      elementosArrastrados.splice(idx, 1);
      renderElementosDrop();
    });
    // Editar elemento
    span.addEventListener("click", function() {
      editandoIdx = idx;
      document.getElementById("editTipo").value = el.tipo;
      document.getElementById("editContenido").value = el.contenido;
      document.getElementById("modal-editar").style.display = "flex";
    });
    dropArea.appendChild(span);
  });
  if (elementosArrastrados.length === 0) {
    dropArea.innerHTML = "Arrastra aquí para añadir a tu página";
  }
}

// Modal edición
const modalEditar = document.getElementById("modal-editar");
document.getElementById("formEditarElemento").addEventListener("submit", function(e) {
  e.preventDefault();
  if (editandoIdx !== null) {
    elementosArrastrados[editandoIdx].tipo = document.getElementById("editTipo").value.trim();
    elementosArrastrados[editandoIdx].contenido = document.getElementById("editContenido").value.trim();
    renderElementosDrop();
    modalEditar.style.display = "none";
    editandoIdx = null;
  }
});
document.getElementById("cancelarEditar").addEventListener("click", function() {
  modalEditar.style.display = "none";
  editandoIdx = null;
});

// Crear página (solo un listener, previene doble envío y siempre envía elementos)
const paginaForm = document.getElementById("paginaForm");
paginaForm.onsubmit = null;
paginaForm.addEventListener("submit", async function(e) {
  e.preventDefault();
  if (window._enviandoPagina) return; // Evita doble envío
  window._enviandoPagina = true;
  const titulo = document.getElementById("paginaTitulo").value;
  const contenido = document.getElementById("paginaContenido").value;
  const result = await createPage(titulo, contenido, elementosArrastrados);
  if (result.success) {
    window.showOutput(result.data.message || "Página creada correctamente", "success");
  } else {
    window.showOutput(result.data?.message || result.data?.error || "Error al crear la página", "error");
  }
  paginaForm.reset();
  elementosArrastrados = [];
  renderElementosDrop();
  cargarPaginas();
  window._enviandoPagina = false;
});

// ...existing code...
      
// Renderizar página pública (incluye elementos arrastrados)
async function renderizarPaginaPublica(paginaId) {
  const result = await getPageById(paginaId);
  
  let cont = document.getElementById("main");
  if (!cont) {
    cont = document.createElement("div");
    cont.id = "main";
    cont.style.marginTop = "24px";
    document.body.appendChild(cont);
  }
  
  if (result.success) {
    const data = result.data;
    cont.innerHTML = `<h2>${data.titulo}</h2><p>${data.contenido}</p>`;
    if (data.elementos && Array.isArray(data.elementos) && data.elementos.length > 0) {
      const lista = document.createElement("div");
      lista.innerHTML = `<h3>Elementos de la página</h3>`;
      data.elementos.forEach(el => {
        const item = document.createElement("div");
        item.style.marginBottom = "8px";
        item.style.padding = "6px 12px";
        item.style.background = "#f8f9fa";
        item.style.borderRadius = "4px";
        item.style.boxShadow = "0 1px 4px #0001";
        item.style.display = "block";
        if (el.tipo === "imagen" && el.contenido) {
          item.innerHTML = `<strong>Imagen:</strong><br><img src="${el.contenido}" alt="imagen" style="max-width:100%;border-radius:6px;box-shadow:0 2px 8px #0002;">`;
        } else if (el.tipo === "video" && el.contenido) {
          item.innerHTML = `<strong>Video:</strong><br><video src="${el.contenido}" controls style="max-width:100%;border-radius:6px;"></video>`;
        } else if (el.tipo === "texto" || el.tipo === "texto extra") {
          item.innerHTML = `<strong>Texto:</strong> ${el.contenido}`;
        } else {
          item.innerHTML = `<strong>${el.tipo}</strong>: ${el.contenido}`;
        }
        lista.appendChild(item);
      });
      cont.appendChild(lista);
    }
  } else {
    cont.innerHTML = `<div style='color:red'>${result.data?.error || "Error al cargar la página"}</div>`;
  }
}

// SPA: detectar ruta /ver/:pagina y renderizar
window.addEventListener("hashchange", () => {
  const hash = location.hash;
  if (window.location.pathname === "/buscar-autor" && hash.startsWith("#/ver/")) {
    document.getElementById("section-ver-pagina").style.display = "block";
    const paginaId = hash.split("#/ver/")[1];
    renderizarPaginaPublica(paginaId);
  } else {
    document.getElementById("section-ver-pagina").style.display = "none";
    document.getElementById("paginaPublica").innerHTML = "";
  }
});

// Al cargar, si la ruta es /ver/:pagina, renderizar
  if (location.hash.startsWith("#/ver/")) {
    if (window.location.pathname === "/buscar-autor") {
      const paginaId = location.hash.split("#/ver/")[1];
      document.getElementById("section-ver-pagina").style.display = "block";
      renderizarPaginaPublica(paginaId);
    } else {
      document.getElementById("section-ver-pagina").style.display = "none";
      document.getElementById("paginaPublica").innerHTML = "";
    }
  }

// showSection solo activa/desactiva secciones existentes
function showSection(route) {
  const sectionPaginas = document.getElementById("section-paginas");
  if (sectionPaginas) sectionPaginas.style.display = route === "/paginas" ? "block" : "none";
  const sectionBuscarAutor = document.getElementById("section-buscar-autor");
  if (sectionBuscarAutor) sectionBuscarAutor.style.display = route === "/buscar-autor" ? "block" : "none";
}

function handleRouteChange() {
  showSection(window.location.pathname);
  // Ocultar detalle de página si no estamos en autores
  if (window.location.pathname !== "/buscar-autor") {
    document.getElementById("section-ver-pagina").style.display = "none";
    document.getElementById("paginaPublica").innerHTML = "";
    if (location.hash.startsWith("#/ver/")) {
      location.hash = "";
    }
  }
}

// Eliminados listeners para nav-register y nav-login (no existen en el HTML)
const navPaginas = document.getElementById("nav-paginas");
if (navPaginas) {
  navPaginas.addEventListener("click", function(e) {
    e.preventDefault();
    window.history.pushState({}, "", "/paginas");
    handleRouteChange();
  });
}
// Listener de Mis páginas ya eliminado
const navAutores = document.getElementById("nav-autores");
if (navAutores) {
  navAutores.addEventListener("click", function(e) {
    e.preventDefault();
    window.history.pushState({}, "", "/buscar-autor");
    showSection("/buscar-autor");
    cargarPublicasAutores();
  });
}

// Delegación para enlaces de páginas públicas
document.addEventListener("click", function(e) {
  if (e.target.classList.contains("ver-pagina-link")) {
    e.preventDefault();
    const href = e.target.getAttribute("href");
    window.history.pushState({}, "", href);
    handleRouteChange();
  }
});

window.addEventListener("popstate", handleRouteChange);
window.addEventListener("DOMContentLoaded", () => {
  window.history.replaceState({}, "", "/buscar-autor");
  handleRouteChange();
  // Si la ruta es /buscar-autor, cargar páginas públicas automáticamente
  if (window.location.pathname === "/buscar-autor") {
    cargarPublicasAutores();
  }
});


// Cargar páginas públicas en sección de autores
async function cargarPublicasAutores() {
  const lista = document.getElementById("listaPublicasAutores");
  if (!lista) return;
  lista.innerHTML = "Cargando...";
  const result = await getPublicPages();
  lista.innerHTML = "";
  if (result.success && result.data.length > 0) {
    window.showOutput(`Autores cargados: ${result.data.length}`, "success");
    result.data.forEach(p => {
      const li = document.createElement("li");
      li.innerHTML = `<a href="#/ver/${p.id}" class="ver-pagina-link"><strong>${p.titulo}</strong></a> <span style='color:#888'>(Autor: ${p.username})</span>`;
      lista.appendChild(li);
    });
  } else {
    window.showOutput(result.data?.message || result.data?.error || "Error al cargar autores", "error");
  }
}


    </script>
  </body>
</html>
